<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
				<title>Clock In/Out Tracker</title>
				<style>
					body {
						font-family: Arial, sans-serif;
						margin: 50px;
					}
				.container {
					max-width: 300px;
					margin: auto;
					text-align: center;
				}
				input[type="text"], input[type="datetime-local"], button {
					padding: 10px;
					margin: 5px;
					width: 100%;
				}
				</style>
	</head>
	<body>
		<div class="container">
			<h1>Clock In/Out</h1>
			<input type="text" id="userInput" placeholder="Enter your name">
				<input type="text" id="assignmentInput" placeholder="Enter your assignment">
					<input type="datetime-local" id="dateTimeInput">
						<button onclick="clockIn()">Clock In</button>
						<button onclick="clockOut()">Clock Out</button>
						
						<h2>Get Records</h2>
						<input type="datetime-local" id="startDate">
							<input type="datetime-local" id="endDate">
								<button onclick="getRecords()">Get Records</button>
								<button onclick="getLastWeekRecords()">Last Week</button>
								<button onclick="getLastMonthRecords()">Last Month</button>
								</div>
		
		<script>
			function setDefaultDateTime() {
				const now = new Date();
				const localDateTime = now.toISOString().slice(0, 16);
				document.getElementById('dateTimeInput').value = localDateTime;
				document.getElementById('startDate').value = localDateTime;
				document.getElementById('endDate').value = localDateTime;
			}
		
		function formatDateToLocalISOString(date) {
			const offset = date.getTimezoneOffset();
			const localDate = new Date(date.getTime() - offset * 60 * 1000);
			return localDate.toISOString().slice(0, 16);
		}
		
		window.onload = setDefaultDateTime;
		
		async function clockIn() {
			const name = document.getElementById('userInput').value;
			const assignment = document.getElementById('assignmentInput').value;
			const dateTime = document.getElementById('dateTimeInput').value;
			if (name && dateTime) {
				const response = await fetch('/clock-in', {
											 method: 'POST',
											 headers: { 'Content-Type': 'application/json' },
											 body: JSON.stringify({ name: name, time: dateTime, assignment: assignment })
											 });
											 alert(await response.text());
			} else {
				alert('Please enter your name and select a date/time.');
			}
		}
		
		async function clockOut() {
			const name = document.getElementById('userInput').value;
			const assignment = document.getElementById('assignmentInput').value;
			const dateTime = document.getElementById('dateTimeInput').value;
			if (name && dateTime) {
				const response = await fetch('/clock-out', {
											 method: 'POST',
											 headers: { 'Content-Type': 'application/json' },
											 body: JSON.stringify({ name: name, time: dateTime, assignment: assignment })
											 });
											 alert(await response.text());
			} else {
				alert('Please enter your name and select a date/time.');
			}
		}
		
		async function getRecords() {
			const startDate = document.getElementById('startDate').value;
			const endDate = document.getElementById('endDate').value;
			const name = document.getElementById('userInput').value;
			if (name) {
				if (startDate && endDate) {
					const response = await fetch(`/records?start=${startDate}&end=${endDate}&name=${name}`);
					const data = await response.json();
					
						// Create a CSV string
						let csvContent = "data:text/csv;charset=utf-8,Name,Assignment,Clock-in time,Clock-out time,Time at Work\n";
						csvContent += data.map(record => {
											   const clockInTime = new Date(record.clockInTime);
											   const clockOutTime = new Date(record.clockOutTime);
											   const timeAtWork = calculateTimeAtWork(clockInTime, clockOutTime);
											   return `${record.name},${record.assignment},${record.clockInTime},${record.clockOutTime},${timeAtWork}`;
											   }).join("\n");
											   
												   // Create a download link
												   const encodedUri = encodeURI(csvContent);
												   const link = document.createElement("a");
												   link.setAttribute("href", encodedUri);
												   
													   // Format filename
													   const startFormat = formatDateToLocalISOString(new Date(startDate)).slice(0, 10).replace(/-/g, '');
													   const endFormat = formatDateToLocalISOString(new Date(endDate)).slice(0, 10).replace(/-/g, '');
													   const fileName = `${name}_${startFormat}_${endFormat}.csv`;
													   
													   link.setAttribute("download", fileName);
													   document.body.appendChild(link); // Required for FF
													   
														   // Start download
														   link.click();
														   document.body.removeChild(link); // Clean up
				} else {
					alert('Please select both start and end dates.');
				}
			} else {
				alert('Please enter your name.');
			}
		}
		
		function calculateTimeAtWork(clockInTime, clockOutTime) {
			const diff = (clockOutTime - clockInTime) / 1000; // difference in seconds
			const hours = Math.floor(diff / 3600);
			const minutes = Math.floor((diff % 3600) / 60);
			return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
		}
		
		async function getLastWeekRecords() {
			const endDate = new Date();
			const startDate = new Date();
			startDate.setDate(endDate.getDate() - 7);
			document.getElementById('startDate').value = formatDateToLocalISOString(startDate);
			document.getElementById('endDate').value = formatDateToLocalISOString(endDate);
			getRecords();
		}
		
		async function getLastMonthRecords() {
			const endDate = new Date();
			const startDate = new Date();
			startDate.setMonth(endDate.getMonth() - 1);
			document.getElementById('startDate').value = formatDateToLocalISOString(startDate);
			document.getElementById('endDate').value = formatDateToLocalISOString(endDate);
			getRecords();
		}
		</script>
	</body>
</html>

