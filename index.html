<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
				<title>Clock In/Out Tracker</title>
				<link rel="manifest" href="./manifest.json">
					<link rel="icon" href="./icons/favicon.ico" type="image/x-icon">
						<style>
							body {
								font-family: Arial, sans-serif;
								margin: 50px;
							}
						.container {
							max-width: 300px;
							margin: auto;
							text-align: center;
						}
						input[type="text"], input[type="datetime-local"], button {
							padding: 10px;
							margin: 5px;
							width: 100%;
						}
						</style>
	</head>
	<body>
		<div class="container">
			<h1>Clock In/Out</h1>
			<input type="text" id="qgendaurl" placeholder="Enter Qgenda Calendar URL">
			<input type="text" id="assignmentInput" placeholder="Enter your assignment">
				<input type="datetime-local" id="dateTimeInput">
					<button id="clockInButton" onclick="clockIn()">Clock In</button>
					<button id="clockOutButton" onclick="clockOut()" disabled>Clock Out</button>
					
					<h2>Get Records</h2>
					<input type="datetime-local" id="startDate">
						<input type="datetime-local" id="endDate">
							<button onclick="getRecords()">Get Records</button>
							<button onclick="getLastWeekRecords()">Last Week</button>
							<button onclick="getLastMonthRecords()">Last Month</button>
							<button onclick="clearLocalStorage()">Clear Local Storage</button>
							</div>
		
		<script>
			function initializeDateTimeInputs() {
				const now = new Date();
				const localDateTime = formatDateTime(now);
				document.getElementById('dateTimeInput').value = localDateTime;
				document.getElementById('startDate').value = localDateTime;
				document.getElementById('endDate').value = localDateTime;
			}
		
		function formatDateTime(date) {
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');
			return `${year}-${month}-${day}T${hours}:${minutes}`;
		}
		
		function getLocalStorageRecords() {
			const records = localStorage.getItem('records');
			return records ? JSON.parse(records) : [];
		}
		
		function saveLocalStorageRecords(records) {
			localStorage.setItem('records', JSON.stringify(records));
		}
		async function fetchCalendar(url) {
			try {
				const response = await fetch(url);
				const data = await response.text();
				return data;
			} catch (error) {
				console.error('Error fetching calendar:', error);
				return null;
			}
		}
		
		function parseICal(data) {
			const events = [];
			const lines = data.split('\n');
			let event = null;
			
			for (const line of lines) {
				if (line.startsWith('BEGIN:VEVENT')) {
					event = { details: {} };
				} else if (line.startsWith('SUMMARY:')) {
					event.details.summary = line.replace('SUMMARY:', '');
				} else if (line.startsWith('DTSTART:')) {
					event.details.start = line.replace('DTSTART:', '');
				} else if (line.startsWith('DTEND:')) {
					event.details.end = line.replace('DTEND:', '');
				} else if (line.startsWith('END:VEVENT')) {
					if (event) {
						events.push(event);
						event = null;
					}
				}
			}
			
			return events;
		}
		
		function getTodayAssignments(events) {
			const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
			return events.filter(event => {
								 const startDate = event.details.start.slice(0, 8); // YYYYMMDD
								 return startDate === today.replace(/-/g, '');
								 });
		}
		
		async function displayTodaysAssignment() {
			const url = document.getElementById('qgendaurl').value();
			const calendarData = await fetchCalendar(url);
			
			if (calendarData) {
				const events = parseICal(calendarData);
				const todayAssignments = getTodayAssignments(events);
				
				const assignmentDiv = document.getElementById('assignment');
				if (todayAssignments.length > 0) {
					assignmentDiv.textContent = todayAssignments[0].details.summary; // Displaying the first assignment of the day
				} else {
					assignmentDiv.textContent = 'No assignments for today.';
				}
			} else {
				document.getElementById('assignmentInput').textContent = 'Failed to fetch calendar data.';
			}
		}
		
		displayTodaysAssignment();
		
		
		
		
		
		
		async function clockIn() {
			const assignment = document.getElementById('assignmentInput').value;
			const dateTime = document.getElementById('dateTimeInput').value;
			
			if (assignment && dateTime) {
				const records = getLocalStorageRecords();
				records.push({
							 clockInTime: new Date(dateTime).toLocaleString(),
							 assignment: assignment,
							 clockOutTime: null,
							 });
							 saveLocalStorageRecords(records);
							 alert('Clock In recorded');
							 
							 document.getElementById('clockInButton').disabled = true;
							 document.getElementById('clockOutButton').disabled = false;
			} else {
				alert('Please enter your assignment and select a date/time.');
			}
		}
		
		async function clockOut() {
			const dateTime = document.getElementById('dateTimeInput').value;
			
			if (dateTime) {
				const records = getLocalStorageRecords();
				const lastClockInIndex = records.length - 1;
				
				if (records[lastClockInIndex].clockOutTime === null) {
					records[lastClockInIndex].clockOutTime = new Date(dateTime).toLocaleString();
					saveLocalStorageRecords(records);
					alert('Clock Out recorded');
					
					document.getElementById('clockInButton').disabled = false;
					document.getElementById('clockOutButton').disabled = true;
				} else {
					alert('No matching clock-in record found.');
				}
			} else {
				alert('Please select a date/time.');
			}
		}
		
		function getRecords() {
			const startDate = new Date(document.getElementById('startDate').value).toLocaleString();
			const endDate = new Date(document.getElementById('endDate').value).toLocaleString();
			
			const records = getLocalStorageRecords();
			const filteredRecords = records.filter(record => {
												   return record.clockInTime &&
												   record.clockOutTime &&
												   new Date(record.clockInTime) >= new Date(startDate) &&
												   new Date(record.clockOutTime) <= new Date(endDate);
												   });
												   
												   if (filteredRecords.length === 0) {
													   alert('No data exists for the selected time period.');
													   return;
												   }
												   
												   const csvContent = generateCSV(filteredRecords);
												   downloadCSV(csvContent, `records_${formatDate(startDate)}_${formatDate(endDate)}.csv`);
		}
		
		function generateCSV(records) {
			const csvHeaders = ['Assignment', 'Clock-in Time', 'Clock-out Time', 'Time at Work'];
			const csvRows = [csvHeaders.join(',')];
			
			records.forEach(record => {
							const row = [
										 `"${record.assignment}"`,
										 `"${record.clockInTime}"`,
										 `"${record.clockOutTime}"`,
										 `"${calculateTimeAtWork(new Date(record.clockInTime), new Date(record.clockOutTime))}"`
										 ];
							csvRows.push(row.join(','));
							});
							
							return csvRows.join('\n');
		}
		
		function downloadCSV(csvContent, filename) {
			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			a.click();
			URL.revokeObjectURL(url);
		}
		
		function calculateTimeAtWork(clockInTime, clockOutTime) {
			const diff = (clockOutTime - clockInTime) / 1000; // difference in seconds
			const hours = Math.floor(diff / 3600);
			const minutes = Math.floor((diff % 3600) / 60);
			return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
		}
		
		function formatDate(date) {
			const d = new Date(date);
			return d.toLocaleDateString().replace(/\//g, '');
												  }
												  
												  function formatDateTime(inputDateTime) {
												  const date = new Date(inputDateTime);
												  const pad = (num, size) => num.toString().padStart(size, '0');
												  const year = date.getFullYear();
												  const month = pad(date.getMonth() + 1, 2);
												  const day = pad(date.getDate(), 2);
												  const hours = pad(date.getHours(), 2);
												  const minutes = pad(date.getMinutes(), 2);
												  const seconds = pad(date.getSeconds(), 2);
												  return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
												  }
												  
												  function getLastWeekRecords() {
												  const endDate = new Date();
												  const startDate = new Date();
												  startDate.setDate(endDate.getDate() - 7);
												  document.getElementById('startDate').value = formatDateTime(startDate);
												  document.getElementById('endDate').value = formatDateTime(endDate);
												  getRecords();
												  }
												  
												  function getLastMonthRecords() {
												  const endDate = new Date();
												  const startDate = new Date();
												  startDate.setMonth(endDate.getMonth() - 1);
												  document.getElementById('startDate').value = formatDateTime(startDate);
												  document.getElementById('endDate').value = formatDateTime(endDate);
												  getRecords();
												  }
												  
												  function clearLocalStorage() {
												  localStorage.removeItem('records');
												  alert('Local storage cleared.');
												  }
												  
												  window.onload = initializeDateTimeInputs;
												  
												  // Service Worker registration
												  if ('serviceWorker' in navigator) {
												  window.addEventListener('load', function() {
																		  navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
																																	   console.log('ServiceWorker registration successful with scope: ', registration.scope);
																																	   }).catch(function(error) {
																																				console.log('ServiceWorker registration failed: ', error);
																																				});
																		  });
												  }
												  </script>
	</body>
</html>

